#!/usr/bin/env ruby

require 'rubygems'
require 'twitter'
require 'pastie-api'
require 'optparse'
require 'extensions'
require 'wputils'

usage = "Usage: wp [{-m --message} MESSAGE] [{-t --tag} TAG] filename \ 
       wp {-v --version} \
       wp {-h --help}"

options = {}
OptionParser.new do |opt|
  opt.banner = usage
  opt.version = '0.1.1.2'
  opt.on('-m', '--message MESSAGE') { |o| options[:message] = o }
  opt.on('-t', '--tag TAG') { |o| options[:tag] = o }
  opt.on('-v', '--version') do |o|
    puts 'Version: wp #{opt.version}'
    exit 0
  end
  opt.on('-h', '--help') do
    puts opt.banner
    exit 0
  end
end.parse!

if ARGV.empty? or ARGV.length > 1 then
  puts usage
  exit 1
end

sendfile=ARGV[0]
unless options[:message] == nil 
  user_message = options[:message]
else
  user_message = ""
end

yamlconf = getWPcfgFile()

# Reading a file
unless File::exist? sendfile or File::readable? sendfile
  puts "Error: file #{sendfile} does not exist or not readable"
  exit 1
end

file = File.new(sendfile, "r")
conts = ""
file.each_line do |line|
  conts += line
end
file.close

# Create a new paste
le = LangExtensions.instance
lang = le.getLangDesc(File.extname sendfile)
exts = File.extname sendfile
# puts "Extension: #{exts}"
comm = lang.prodComment('filename: ' + (File.basename sendfile))
conts = comm + conts
p = Pastie.create(conts, false, lang.name)

# Getting environment variables that contains the tag info
tag = getWPTag(options)

# Setting twitter client
client = get_tweeter_client(yamlconf)

# Send a twitter with new file info
begin
  tweet_message = tag + " " + user_message + " " + p.link
  if tweet_message.length > 240
    puts "wp cannot send message: #{tweet_message} because too long: #{tweet_emssage.length}"
    exit 1
  end
  client.update(tweet_message)
rescue Exception => e
  puts "wp could not sent message send due: #{e.message}"
  exit 1
end
