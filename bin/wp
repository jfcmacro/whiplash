#!/usr/bin/env ruby

require 'rubygems'
require 'twitter'
require 'pastie-api'
require 'optparse'
require 'extensions'
require 'wputils'
require 'whiplash/version'

usage = "Usage: wp [OPTIONS]"

options = {}
OptionParser.new do |opt|
  opt.banner = usage
  opt.version = Whiplash::VERSION
  opt.separator ""
  opt.separator "Specific options:"
  opt.on('-m',
         '--message MESSAGE',
         String,
         'A MESSAGE to be sent') { |o| options[:message] = o }
  opt.on('-t',
         '--tag TAG',
         String,
         'A TAG that identifies a group',
         'of persons interested on the message'
        ) { |o| options[:tag] = o }
  opt.on('-v', '--version') do |o|
    puts 'wp version "' + opt.version + '"'
    exit 0
  end
  opt.on('-h', '--help') do |o|
    puts opt.help
    exit
  end
end.parse!

if ARGV.empty? or ARGV.length > 1 then
  puts usage
  exit 1
end

sendfile=ARGV[0]
unless options[:message] == nil
  user_message = options[:message]
else
  user_message = ""
end

yamlconf = getWPcfgFile()

# Reading a file
unless File::exist? sendfile or File::readable? sendfile
  puts "Error: file #{sendfile} does not exist or not readable"
  exit 1
end

file = File.new(sendfile, "r")
conts = ""
file.each_line do |line|
  conts += line
end
file.close

# Create a new paste
le = LangExtensions.instance
lang = le.getLangDesc(File.extname sendfile)
exts = File.extname sendfile
comm = lang.prodComment('filename: ' + (File.basename sendfile))
conts = conts + comm
p = Pastie.create(conts, false, lang.name)

# Getting environment variables that contains the tag info
tag = getWPTag(options)

# Setting twitter client
client = get_tweeter_client(yamlconf)

# Send a twitter with new file info
begin
  tweet_message = tag + " " + user_message + " " + p.link
  if tweet_message.length > 240
    puts "wp cannot send message: #{tweet_message} because too long: #{tweet_emssage.length}"
    exit 1
  end
  tweet = client.update(tweet_message)
  puts "Tweet id: #{tweet.id}"
rescue Exception => e
  puts "wp could not sent message send due: #{e.message}"
  exit 1
end
